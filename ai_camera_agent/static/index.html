<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Agent - æ§åˆ¶å°</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        /* é¡¶éƒ¨æ  */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        h1 { margin: 0; font-size: 1.5rem; }

        /* ç™»å½•æ¡† */
        #login-panel {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            background: #404040;
            border: 1px solid #555;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }

        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background: #45a049; }
        button:disabled { background: #555; cursor: not-allowed; }

        /* é¢æ¿é€šç”¨æ ·å¼ */
        .panel {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .panel-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        /* å·¦ä¾§ï¼šç³»ç»ŸçŠ¶æ€ */
        #status-panel {
            grid-column: 1;
            grid-row: 2;
        }

        .status-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        /* ä¸­é—´ï¼šè§†é¢‘ä¸å¯¹è¯ */
        #center-area {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #video-container {
            flex: 2;
            background: black;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 300px;
        }

        #video-feed {
            max-width: 100%;
            max-height: 100%;
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #chat-history {
            flex: 1;
            background: #222;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .msg { margin-bottom: 8px; line-height: 1.4; }
        .msg.user { color: #64b5f6; }
        .msg.agent { color: #81c784; }
        .msg.system { color: #aaa; font-style: italic; }

        #chat-input-area {
            display: flex;
            gap: 10px;
        }

        #chat-input { flex: 1; }

        /* å³ä¾§ï¼šæŠ¥è­¦æ—¥å¿— */
        #alert-panel {
            grid-column: 3;
            grid-row: 2;
        }

        #alert-list {
            flex: 1;
            overflow-y: auto;
        }

        .alert-item {
            background: #402020;
            border-left: 3px solid var(--danger-color);
            padding: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            border-radius: 2px;
            animation: fadeIn 0.3s;
        }

        .alert-item.info {
            background: #203040;
            border-left-color: #2196f3;
        }

        .alert-time {
            color: #aaa;
            font-size: 0.75rem;
            margin-bottom: 2px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .badge-success { background: #388e3c; }
        .badge-error { background: #d32f2f; }

        #connection-status {
            font-size: 0.8rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center">
            <h1>ğŸ‘ï¸ AI Camera Agent</h1>
            <span id="connection-status" class="badge badge-error">æœªè¿æ¥</span>
        </div>

        <div id="login-panel">
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" id="password" placeholder="å¯†ç " value="password">
            <button onclick="login()" id="btn-login">ç™»å½•</button>
            <button onclick="logout()" id="btn-logout" style="display:none; background:#555">ç™»å‡º</button>
        </div>
    </header>

    <div id="status-panel" class="panel">
        <div class="panel-header">
            <span>ğŸ“Š ç³»ç»ŸçŠ¶æ€</span>
            <button onclick="refreshStatus()" style="font-size:0.8rem; padding:2px 8px;">åˆ·æ–°</button>
        </div>
        <div id="status-content">
            <div class="status-item"><span>æœåŠ¡çŠ¶æ€:</span> <span id="st-service">æœªçŸ¥</span></div>
            <div class="status-item"><span>API è¿æ¥:</span> <span id="st-api">âŒ</span></div>
            <div class="status-item"><span>Token:</span> <span id="st-token">æ— </span></div>
            <hr style="border-color:#444; width:100%">
            <div class="status-item"><span>å½•åˆ¶çŠ¶æ€:</span> <span id="st-recording">-</span></div>
            <div class="status-item"><span>åˆ†è¾¨ç‡:</span> <span id="st-resolution">-</span></div>
            <div class="status-item"><span>FPS:</span> <span id="st-fps">-</span></div>
        </div>
    </div>

    <div id="center-area">
        <div id="video-container" class="panel" style="padding:0">
            <img id="video-feed" alt="ç­‰å¾…è§†é¢‘ä¿¡å·..." style="display:none">
            <div id="video-placeholder" style="color:#aaa">ğŸ“º ç­‰å¾…è¿æ¥è§†é¢‘æµ...</div>
        </div>

        <div id="chat-container" class="panel">
            <div class="panel-header">ğŸ’¬ ä¸ Agent å¯¹è¯</div>
            <div id="chat-history">
                <div class="msg system">è¯·å…ˆç™»å½•ä»¥å¼€å§‹å¯¹è¯...</div>
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š'ç³»ç»ŸçŠ¶æ€æ€ä¹ˆæ ·'ï¼Œ'åªæ£€æµ‹äºº'..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" id="btn-send" disabled>å‘é€</button>
            </div>
        </div>
    </div>

    <div id="alert-panel" class="panel">
        <div class="panel-header">
            <span>ğŸ”” å®æ—¶è­¦æŠ¥</span>
            <button onclick="clearAlerts()" style="font-size:0.8rem; padding:2px 8px; background:#555">æ¸…ç©º</button>
        </div>
        <div id="alert-list">
            </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000";
        const WS_BASE = "ws://localhost:8000";
        let accessToken = localStorage.getItem("access_token");
        let videoWs = null;
        let alertWs = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            if(accessToken) {
                onLoginSuccess();
            } else {
                logChat("system", "æ¬¢è¿ï¼è¯·ä½¿ç”¨å³ä¸Šè§’é»˜è®¤è´¦å·(admin/password)ç™»å½•ã€‚");
            }
        };

        // --- è®¤è¯æ¨¡å— ---

        async function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const btn = document.getElementById("btn-login");

            try {
                btn.disabled = true;
                btn.innerText = "ç™»å½•ä¸­...";

                const url = `${API_BASE}/api/v1/auth/login?username=${username}&password=${password}`;
                const response = await fetch(url, { method: "POST" });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem("access_token", accessToken);
                    onLoginSuccess();
                } else {
                    alert("ç™»å½•å¤±è´¥: " + response.statusText);
                }
            } catch (e) {
                alert("è¿æ¥é”™è¯¯: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç™»å½•";
            }
        }

        function logout() {
            accessToken = null;
            localStorage.removeItem("access_token");
            location.reload();
        }

        function onLoginSuccess() {
            document.getElementById("login-panel").innerHTML = `
                <span style="color:#81c784; margin-right:10px">âœ… å·²ç™»å½•</span>
                <button onclick="logout()" style="background:#d32f2f">ç™»å‡º</button>
            `;
            document.getElementById("st-token").innerText = "æœ‰æ•ˆ";
            document.getElementById("st-token").style.color = "#81c784";
            document.getElementById("btn-send").disabled = false;
            document.getElementById("connection-status").className = "badge badge-success";
            document.getElementById("connection-status").innerText = "åœ¨çº¿";

            logChat("system", "ç™»å½•æˆåŠŸï¼æ­£åœ¨è¿æ¥æœåŠ¡...");

            // å¯åŠ¨å„é¡¹è¿æ¥
            connectVideoWs();
            connectAlertWs();
            refreshStatus();
        }

        // --- è§†é¢‘æµæ¨¡å— ---

        function connectVideoWs() {
            if (videoWs) videoWs.close();

            const img = document.getElementById("video-feed");
            const placeholder = document.getElementById("video-placeholder");

            videoWs = new WebSocket(`${WS_BASE}/ws/video`);
            videoWs.binaryType = "blob";

            videoWs.onopen = () => {
                console.log("Video WS Connected");
                placeholder.style.display = "none";
                img.style.display = "block";
            };

            videoWs.onmessage = (event) => {
                const url = URL.createObjectURL(event.data);
                img.onload = () => URL.revokeObjectURL(url);
                img.src = url;
            };

            videoWs.onclose = () => {
                console.log("Video WS Closed");
                placeholder.style.display = "block";
                placeholder.innerText = "ğŸ”Œ è§†é¢‘è¿æ¥æ–­å¼€";
                img.style.display = "none";
                setTimeout(connectVideoWs, 3000); // è‡ªåŠ¨é‡è¿
            };
        }

        // --- æŠ¥è­¦æ¨¡å— ---

        function connectAlertWs() {
            if (alertWs) alertWs.close();

            alertWs = new WebSocket(`${WS_BASE}/ws/alerts`);

            alertWs.onopen = () => console.log("Alert WS Connected");

            alertWs.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addAlert(data);
                } catch(e) {
                    console.error("Alert parse error", e);
                }
            };

            alertWs.onclose = () => setTimeout(connectAlertWs, 3000);
        }

        function addAlert(data) {
            const list = document.getElementById("alert-list");
            const div = document.createElement("div");

            // æ ¹æ®ç±»å‹æ ·å¼
            let typeClass = "";
            if (data.type === "alert" || data.is_abnormal) typeClass = ""; // é»˜è®¤çº¢è‰²
            else typeClass = "info";

            div.className = `alert-item ${typeClass}`;

            const time = new Date().toLocaleTimeString();
            div.innerHTML = `
                <div class="alert-time">${time}</div>
                <div style="font-weight:bold">${data.alert || "é€šçŸ¥"}</div>
                <div>${data.description || ""}</div>
            `;

            list.prepend(div);
        }

        function clearAlerts() {
            document.getElementById("alert-list").innerHTML = "";
        }

        // --- å¯¹è¯æ¨¡å— ---

        async function sendMessage() {
            const input = document.getElementById("chat-input");
            const text = input.value.trim();
            if (!text) return;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            logChat("user", text);
            input.value = "";
            input.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/v1/chat`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        question: text,
                        session_id: "web-client"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    logChat("agent", data.answer);
                } else {
                    if(response.status === 401) {
                        logChat("system", "âŒ è®¤è¯è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                        logout();
                    } else {
                        logChat("system", `âŒ è¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                }
            } catch (e) {
                logChat("system", `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        function logChat(role, text) {
            const history = document.getElementById("chat-history");
            const div = document.createElement("div");
            div.className = `msg ${role}`;

            let prefix = "";
            if(role === "user") prefix = "ğŸ‘¤ ä½ : ";
            if(role === "agent") prefix = "ğŸ¤– Agent: ";
            if(role === "system") prefix = "ğŸ”§ ç³»ç»Ÿ: ";

            div.innerText = prefix + text;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        // --- çŠ¶æ€æ¨¡å— ---

        async function refreshStatus() {
            if (!accessToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/v1/video/status`, {
                    headers: { "Authorization": `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("st-service").innerText = "è¿è¡Œä¸­";
                    document.getElementById("st-service").style.color = "#81c784";
                    document.getElementById("st-api").innerText = "âœ…";
                    document.getElementById("st-recording").innerText = data.is_recording ? "âº å½•åˆ¶ä¸­" : "ä¼‘çœ ";
                    document.getElementById("st-resolution").innerText = data.resolution;
                    document.getElementById("st-fps").innerText = data.fps;
                }
            } catch (e) {
                console.warn("Status fetch failed", e);
            }
        }

        // å®šæ—¶åˆ·æ–°çŠ¶æ€
        setInterval(refreshStatus, 10000);

    </script>
</body>
</html>